################################## NETWORK #####################################
bind 0.0.0.0
protected-mode no
port 6379

################################## GENERAL #####################################
# CRITICAL FOR CONTAINERS: Run in foreground
daemonize no

# CRITICAL FOR CONTAINERS: Log to stdout so Podman/Docker can read it
logfile ""

# Set log level (debug, verbose, notice, warning)
loglevel notice

# Load modules (ensure order is correct)
loadmodule /usr/local/valkey/modules/valkeyjson.so
loadmodule /usr/local/valkey/modules/valkeysearch.so
loadmodule /usr/local/valkey/modules/valkeybloom.so

# 1. Directory (Must match your volume mount path)
dir /var/lib/valkey/data

# 2. RDB (Snapshots)
# Save after: 1 hr (1 change), 5 min (100 changes), 1 min (10k changes)
save 3600 1
save 300 100
save 60 10000
dbfilename dump.rdb
rdbcompression yes

# 3. AOF (Append Only File)
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# (Optional) Rename dangerous commands so standard users can't use them
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command CONFIG ""

# Note: You must run 'sysctl vm.overcommit_memory=1' on the HOST machine
# for background saving to work reliably without crashing.